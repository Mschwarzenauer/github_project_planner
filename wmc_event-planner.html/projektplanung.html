<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projektplanung</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav>
    <a href="index.html">📋 Dashboard</a>
    <a href="projektplanung.html" class="active">📊 Projektplanung</a>
    <a href="info.html">ℹ️ Info</a>
</nav>

<header>
    <h1>📊 Projektplanung</h1>
    <p>Detaillierte Planung von Ressourcen, Budget und Timeline</p>
</header>

<div id="app">

<!-- Projekt-Info -->
<section class="form-section">
    <h2>📌 Aktuelles Projekt</h2>
    <p><strong>Projekt:</strong> <span id="currentProjectName">-</span></p>
    <button onclick="backToDashboard()" style="margin-top: 10px; background: #6c757d;">← Zurück zum Dashboard</button>
</section>

<!-- Ressourcenplanung -->
<section class="form-section">
    <h2>👥 Ressourcenplanung</h2>
    
    <label>Team-Mitglied hinzufügen</label>
    <div style="display: flex; gap: 10px;">
        <input id="memberName" type="text" placeholder="Name" style="flex: 1;">
        <input id="memberRole" type="text" placeholder="Rolle" style="flex: 1;">
        <button onclick="addTeamMember()" style="padding: 10px 20px;">Hinzufügen</button>
    </div>

    <table style="margin-top: 15px;">
        <tr>
            <th>Name</th>
            <th>Rolle</th>
            <th>Verfügbarkeit %</th>
            <th>Aktion</th>
        </tr>
        <tbody id="teamTable">
        </tbody>
    </table>
</section>

<!-- Budget-Planung -->
<section class="form-section">
    <h2>💰 Budget-Planung</h2>
    
    <div class="grid-2">
        <div>
            <label>Gesamtbudget (€)</label>
            <input id="totalBudget" type="number" min="0" onchange="saveProjectPlanning()">
        </div>
        <div>
            <label>Bisherige Ausgaben (€)</label>
            <input id="spentBudget" type="number" min="0" onchange="saveProjectPlanning()">
        </div>
    </div>

    <div style="margin-top: 15px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
        <p><strong>Verbleibend:</strong> <span id="budgetRemaining">0</span> €</p>
        <p><strong>Auslastung:</strong> <span id="budgetUsage">0</span>%</p>
    </div>

    <label style="margin-top: 15px;">Ausgaben-Details</label>
    <textarea id="budgetDetails" rows="4" placeholder="Aufschlüsselung der Kosten..." onchange="saveProjectPlanning()"></textarea>
</section>

<!-- Timeline -->
<section class="form-section">
    <h2>📅 Projekt-Timeline</h2>
    
    <label>Wichtige Termine</label>
    <input id="timelineEvents" type="text" placeholder="z.B. Kick-Off: 15.02.2025, Erste Demo: 01.03.2025" onchange="saveProjectPlanning()" style="width: 100%;">
</section>

<!-- Risikoanalyse -->
<section class="form-section">
    <h2>⚠️ Risikoanalyse</h2>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input id="riskName" type="text" placeholder="Risiko-Beschreibung" style="flex: 2;">
        <select id="riskLevel" style="flex: 1;">
            <option value="Niedrig">Niedrig</option>
            <option value="Mittel">Mittel</option>
            <option value="Hoch">Hoch</option>
        </select>
        <button onclick="addRisk()" style="padding: 10px 20px;">Hinzufügen</button>
    </div>

    <table>
        <tr>
            <th>Risiko</th>
            <th>Stufe</th>
            <th>Maßnahmen</th>
            <th>Status</th>
        </tr>
        <tbody id="riskTable">
        </tbody>
    </table>
</section>

<!-- Qualitätskontrolle -->
<section class="form-section">
    <h2>✅ Qualitätskontrolle</h2>
    
    <label>Qualitäts-Metriken</label>
    <textarea id="qualityMetrics" rows="4" placeholder="Code-Review-Standard, Test-Abdeckung, Performance-Anforderungen..." onchange="saveProjectPlanning()"></textarea>

    <label style="margin-top: 15px;">Abhängigkeiten & Blockaden</label>
    <textarea id="blockers" rows="4" placeholder="Externe Abhängigkeiten, fehlende Ressourcen, technische Blockaden..." onchange="saveProjectPlanning()"></textarea>
</section>

<!-- Navigation Footer -->
<section class="form-section">
    <div class="button-group">
        <button onclick="saveProjectPlanning()" class="save-btn">💾 Speichern</button>
    </div>
</section>

</div>

<footer>
    <p>© 2025 Projektplaner • Projektplanung Modul</p>
</footer>

<script>
let currentUser = null;
let currentProject = null;

document.addEventListener("DOMContentLoaded", () => {
    const u = localStorage.getItem("currentUser");
    const p = localStorage.getItem("currentProject");
    
    if (!u) {
        window.location.href = "index.html";
        return;
    }
    
    currentUser = u;
    currentProject = p;
    
    if (!currentProject) {
        alert("Bitte wählen Sie zuerst ein Projekt aus");
        window.location.href = "index.html";
        return;
    }
    
    loadProjectPlanning();
    setActiveNav();
});

function getProjectById(projectId) {
    const projects = JSON.parse(localStorage.getItem("projects") || "{}");
    return projects[projectId] || null;
}

function addTeamMember() {
    const name = document.getElementById("memberName").value.trim();
    const role = document.getElementById("memberRole").value.trim();
    if (!name || !role) return alert("Bitte Name und Rolle eintragen");

    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${name}</td>
        <td>${role}</td>
        <td><input type="number" min="0" max="100" value="100" onchange="saveProjectPlanning()" style="width: 80px;"></td>
        <td><button onclick="this.parentElement.parentElement.remove(); saveProjectPlanning();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">✕</button></td>
    `;
    document.getElementById("teamTable").appendChild(row);
    document.getElementById("memberName").value = "";
    document.getElementById("memberRole").value = "";
    saveProjectPlanning();
}

function addRisk() {
    const name = document.getElementById("riskName").value.trim();
    const level = document.getElementById("riskLevel").value;
    if (!name) return alert("Bitte Risiko-Beschreibung eintragen");

    const row = document.createElement("tr");
    const bgColor = level === "Hoch" ? "#dc3545" : level === "Mittel" ? "#ffc107" : "#28a745";
    row.innerHTML = `
        <td>${name}</td>
        <td><span style="padding: 4px 8px; border-radius: 4px; color: white; background: ${bgColor};">${level}</span></td>
        <td><input type="text" placeholder="Maßnahmen" onchange="saveProjectPlanning()" style="width: 100%;"></td>
        <td><select onchange="saveProjectPlanning();"><option>Offen</option><option>In Arbeit</option><option>Gelöst</option></select></td>
    `;
    document.getElementById("riskTable").appendChild(row);
    document.getElementById("riskName").value = "";
    saveProjectPlanning();
}

function updateBudgetDisplay() {
    const total = parseInt(document.getElementById("totalBudget").value) || 0;
    const spent = parseInt(document.getElementById("spentBudget").value) || 0;
    const remaining = total - spent;
    const usage = total > 0 ? Math.round((spent / total) * 100) : 0;

    document.getElementById("budgetRemaining").textContent = remaining;
    document.getElementById("budgetUsage").textContent = usage;
}

function saveProjectPlanning() {
    if (!currentProject) return;

    try {
        const projects = JSON.parse(localStorage.getItem("projects") || "{}");
        const p = projects[currentProject];
        
        if (!p) return;
        if (!p.projectPlanning) p.projectPlanning = {};

        const team = [];
        document.querySelectorAll("#teamTable tr").forEach(row => {
            const cells = row.querySelectorAll("td");
            if (cells.length >= 3) {
                team.push({
                    name: cells[0].textContent.trim(),
                    role: cells[1].textContent.trim(),
                    availability: cells[2].querySelector("input")?.value || "100"
                });
            }
        });

        const risks = [];
        document.querySelectorAll("#riskTable tr").forEach(row => {
            const cells = row.querySelectorAll("td");
            if (cells.length >= 4) {
                risks.push({
                    name: cells[0].textContent.trim(),
                    level: cells[1].textContent.trim(),
                    measures: cells[2].querySelector("input")?.value || "",
                    status: cells[3].querySelector("select")?.value || "Offen"
                });
            }
        });

        p.projectPlanning = {
            team: team,
            totalBudget: document.getElementById("totalBudget").value || "",
            spentBudget: document.getElementById("spentBudget").value || "",
            budgetDetails: document.getElementById("budgetDetails").value || "",
            timelineEvents: document.getElementById("timelineEvents").value || "",
            risks: risks,
            qualityMetrics: document.getElementById("qualityMetrics").value || "",
            blockers: document.getElementById("blockers").value || ""
        };

        localStorage.setItem("projects", JSON.stringify(projects));
        console.log("Projektplanung gespeichert");
    } catch (e) {
        console.error("Fehler beim Speichern:", e);
    }
}

function loadProjectPlanning() {
    const p = getProjectById(currentProject);
    if (!p) {
        alert("Projekt nicht gefunden");
        window.location.href = "index.html";
        return;
    }

    document.getElementById("currentProjectName").textContent = p.name;
    localStorage.setItem("currentProject", currentProject);

    const data = p.projectPlanning || {};
    
    if (data.team && data.team.length > 0) {
        document.getElementById("teamTable").innerHTML = "";
        data.team.forEach(member => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${member.name}</td>
                <td>${member.role}</td>
                <td><input type="number" min="0" max="100" value="${member.availability || 100}" onchange="saveProjectPlanning()" style="width: 80px;"></td>
                <td><button onclick="this.parentElement.parentElement.remove(); saveProjectPlanning();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">✕</button></td>
            `;
            document.getElementById("teamTable").appendChild(row);
        });
    }

    document.getElementById("totalBudget").value = data.totalBudget || "";
    document.getElementById("spentBudget").value = data.spentBudget || "";
    document.getElementById("budgetDetails").value = data.budgetDetails || "";
    updateBudgetDisplay();

    document.getElementById("timelineEvents").value = data.timelineEvents || "";

    if (data.risks && data.risks.length > 0) {
        document.getElementById("riskTable").innerHTML = "";
        data.risks.forEach(risk => {
            const row = document.createElement("tr");
            const bgColor = risk.level === "Hoch" ? "#dc3545" : risk.level === "Mittel" ? "#ffc107" : "#28a745";
            row.innerHTML = `
                <td>${risk.name}</td>
                <td><span style="padding: 4px 8px; border-radius: 4px; color: white; background: ${bgColor};">${risk.level}</span></td>
                <td><input type="text" placeholder="Maßnahmen" value="${risk.measures || ""}" onchange="saveProjectPlanning()" style="width: 100%;"></td>
                <td><select onchange="saveProjectPlanning();"><option${risk.status === "Offen" ? " selected" : ""}>Offen</option><option${risk.status === "In Arbeit" ? " selected" : ""}>In Arbeit</option><option${risk.status === "Gelöst" ? " selected" : ""}>Gelöst</option></select></td>
            `;
            document.getElementById("riskTable").appendChild(row);
        });
    }

    document.getElementById("qualityMetrics").value = data.qualityMetrics || "";
    document.getElementById("blockers").value = data.blockers || "";
}

function backToDashboard() {
    window.location.href = "index.html";
}

function setActiveNav() {
    document.querySelectorAll("nav a").forEach(link => {
        link.classList.remove("active");
        if (link.href.includes("projektplanung.html")) {
            link.classList.add("active");
        }
    });
}

// Auto-update Budget Display bei Input
document.addEventListener("change", (e) => {
    if (e.target.id === "totalBudget" || e.target.id === "spentBudget") {
        updateBudgetDisplay();
    }
});
</script>

</body>
</html>

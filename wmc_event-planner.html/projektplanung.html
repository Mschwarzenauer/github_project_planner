<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projektplanung</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav>
    <a href="index.html">ğŸ“‹ Dashboard</a>
    <a href="projektplanung.html" class="active">ğŸ“Š Projektplanung</a>
    <a href="info.html">â„¹ï¸ Info</a>
</nav>

<header>
    <h1>ğŸ“Š Projektplanung</h1>
    <p>Detaillierte Planung von Ressourcen, Budget und Timeline</p>
</header>

<div id="app">

<!-- Ressourcenplanung -->
<section class="form-section">
    <h2>ğŸ‘¥ Ressourcenplanung</h2>
    
    <label>Team-Mitglied hinzufÃ¼gen</label>
    <div style="display: flex; gap: 10px;">
        <input id="memberName" type="text" placeholder="Name" style="flex: 1;">
        <input id="memberRole" type="text" placeholder="Rolle" style="flex: 1;">
        <button onclick="addTeamMember()" style="padding: 10px 20px;">HinzufÃ¼gen</button>
    </div>

    <table style="margin-top: 15px;">
        <tr>
            <th>Name</th>
            <th>Rolle</th>
            <th>VerfÃ¼gbarkeit %</th>
            <th>Aktion</th>
        </tr>
        <tbody id="teamTable">
        </tbody>
    </table>
</section>

<!-- Budget-Planung -->
<section class="form-section">
    <h2>ğŸ’° Budget-Planung</h2>
    
    <div class="grid-2">
        <div>
            <label>Gesamtbudget (â‚¬)</label>
            <input id="totalBudget" type="number" min="0" onchange="saveProjectPlanning()">
        </div>
        <div>
            <label>Bisherige Ausgaben (â‚¬)</label>
            <input id="spentBudget" type="number" min="0" onchange="saveProjectPlanning()">
        </div>
    </div>

    <div style="margin-top: 15px; padding: 15px; background: #f0f0f0; border-radius: 8px;">
        <p><strong>Verbleibend:</strong> <span id="budgetRemaining">0</span> â‚¬</p>
        <p><strong>Auslastung:</strong> <span id="budgetUsage">0</span>%</p>
    </div>

    <label style="margin-top: 15px;">Ausgaben-Details</label>
    <textarea id="budgetDetails" rows="4" placeholder="AufschlÃ¼sselung der Kosten..." onchange="saveProjectPlanning()"></textarea>
</section>

<!-- Timeline -->
<section class="form-section">
    <h2>ğŸ“… Projekt-Timeline</h2>
    
    <label>Wichtige Termine</label>
    <input id="timelineEvents" type="text" placeholder="z.B. Kick-Off: 15.02.2025, Erste Demo: 01.03.2025" onchange="saveProjectPlanning()" style="width: 100%;">

    <div style="margin-top: 15px;">
        <h3>Timeline-Ãœbersicht</h3>
        <div id="timelineList" style="background: #f9f9f9; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
        </div>
    </div>
</section>

<!-- Risikoanalyse -->
<section class="form-section">
    <h2>âš ï¸ Risikoanalyse</h2>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input id="riskName" type="text" placeholder="Risiko-Beschreibung" style="flex: 2;">
        <select id="riskLevel" style="flex: 1;">
            <option value="Niedrig">Niedrig</option>
            <option value="Mittel">Mittel</option>
            <option value="Hoch">Hoch</option>
        </select>
        <button onclick="addRisk()" style="padding: 10px 20px;">HinzufÃ¼gen</button>
    </div>

    <table>
        <tr>
            <th>Risiko</th>
            <th>Stufe</th>
            <th>MaÃŸnahmen</th>
            <th>Status</th>
        </tr>
        <tbody id="riskTable">
        </tbody>
    </table>
</section>

<!-- QualitÃ¤tskontrolle -->
<section class="form-section">
    <h2>âœ… QualitÃ¤tskontrolle</h2>
    
    <label>QualitÃ¤ts-Metriken</label>
    <textarea id="qualityMetrics" rows="4" placeholder="Code-Review-Standard, Test-Abdeckung, Performance-Anforderungen..." onchange="saveProjectPlanning()"></textarea>

    <label style="margin-top: 15px;">AbhÃ¤ngigkeiten & Blockaden</label>
    <textarea id="blockers" rows="4" placeholder="Externe AbhÃ¤ngigkeiten, fehlende Ressourcen, technische Blockaden..." onchange="saveProjectPlanning()"></textarea>
</section>

<!-- Navigation Footer -->
<section class="form-section">
    <div class="button-group">
        <button onclick="saveProjectPlanning()" class="save-btn">ğŸ’¾ Speichern</button>
    </div>
</section>

</div>

<footer>
    <p>Â© 2025 Projektplaner â€¢ Projektplanung Modul</p>
</footer>

<script>
let currentUser = null;

// Auto-Save
document.addEventListener("change", saveProjectPlanning);
document.addEventListener("input", () => updateBudgetDisplay());

window.addEventListener("beforeunload", () => {
    if (currentUser) saveProjectPlanning();
});

/* Team Management */
function addTeamMember() {
    const name = memberName.value.trim();
    const role = memberRole.value.trim();
    if (!name || !role) return alert("Bitte Name und Rolle eintragen");

    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${name}</td>
        <td>${role}</td>
        <td><input type="number" min="0" max="100" value="100" onchange="saveProjectPlanning()" style="width: 80px;"></td>
        <td><button onclick="this.parentElement.parentElement.remove(); saveProjectPlanning();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">âœ•</button></td>
    `;
    teamTable.appendChild(row);
    memberName.value = "";
    memberRole.value = "";
    saveProjectPlanning();
}

function addRisk() {
    const name = riskName.value.trim();
    const level = riskLevel.value;
    if (!name) return alert("Bitte Risiko-Beschreibung eintragen");

    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${name}</td>
        <td><span style="padding: 4px 8px; border-radius: 4px; color: white; background: ${level === 'Hoch' ? '#dc3545' : level === 'Mittel' ? '#ffc107' : '#28a745'};">${level}</span></td>
        <td><input type="text" placeholder="MaÃŸnahmen" onchange="saveProjectPlanning()" style="width: 100%;"></td>
        <td><select onchange="saveProjectPlanning();"><option>Offen</option><option>In Arbeit</option><option>GelÃ¶st</option></select></td>
    `;
    riskTable.appendChild(row);
    riskName.value = "";
    saveProjectPlanning();
}

/* Budget */
function updateBudgetDisplay() {
    const total = parseInt(totalBudget.value) || 0;
    const spent = parseInt(spentBudget.value) || 0;
    const remaining = total - spent;
    const usage = total > 0 ? Math.round((spent / total) * 100) : 0;

    budgetRemaining.textContent = remaining;
    budgetUsage.textContent = usage;
}

/* Storage */
function saveProjectPlanning() {
    if (!currentUser) {
        console.error("Kein User eingeloggt");
        return;
    }

    try {
        const users = JSON.parse(localStorage.getItem("users") || "{}");
        
        // Stelle sicher, dass data Objekt existiert
        if (!users[currentUser]) {
            users[currentUser] = { password: "", data: {} };
        }
        if (!users[currentUser].data) {
            users[currentUser].data = {};
        }

        // Team auslesen
        const team = [];
        document.querySelectorAll("#teamTable tr").forEach(row => {
            const cells = row.querySelectorAll("td");
            if (cells.length >= 3) {
                team.push({
                    name: cells[0].textContent.trim(),
                    role: cells[1].textContent.trim(),
                    availability: cells[2].querySelector("input")?.value || "100"
                });
            }
        });

        // Risiken auslesen
        const risks = [];
        document.querySelectorAll("#riskTable tr").forEach(row => {
            const cells = row.querySelectorAll("td");
            if (cells.length >= 4) {
                const levelCell = cells[1].textContent.trim();
                risks.push({
                    name: cells[0].textContent.trim(),
                    level: levelCell === "Hoch" ? "Hoch" : levelCell === "Mittel" ? "Mittel" : "Niedrig",
                    measures: cells[2].querySelector("input")?.value || "",
                    status: cells[3].querySelector("select")?.value || "Offen"
                });
            }
        });

        // Speichern
        users[currentUser].data.projectPlanning = {
            team: team,
            totalBudget: document.getElementById("totalBudget")?.value || "",
            spentBudget: document.getElementById("spentBudget")?.value || "",
            budgetDetails: document.getElementById("budgetDetails")?.value || "",
            timelineEvents: document.getElementById("timelineEvents")?.value || "",
            risks: risks,
            qualityMetrics: document.getElementById("qualityMetrics")?.value || "",
            blockers: document.getElementById("blockers")?.value || ""
        };

        localStorage.setItem("users", JSON.stringify(users));
        console.log("Erfolgreich gespeichert:", users[currentUser].data.projectPlanning);
    } catch (e) {
        console.error("Fehler beim Speichern:", e);
    }
}

function loadProjectPlanning() {
    if (!currentUser) {
        console.error("Kein User eingeloggt");
        return;
    }

    try {
        const users = JSON.parse(localStorage.getItem("users") || "{}");
        const data = (users[currentUser]?.data?.projectPlanning) || {};
        
        console.log("Lade Projektplanung:", data);

        // Team laden
        if (data.team && data.team.length > 0) {
            const teamTable = document.getElementById("teamTable");
            teamTable.innerHTML = "";
            data.team.forEach(member => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.role}</td>
                    <td><input type="number" min="0" max="100" value="${member.availability || 100}" onchange="saveProjectPlanning()" style="width: 80px;"></td>
                    <td><button onclick="this.parentElement.parentElement.remove(); saveProjectPlanning();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">âœ•</button></td>
                `;
                teamTable.appendChild(row);
            });
        }

        // Budget laden
        const totalBudget = document.getElementById("totalBudget");
        const spentBudget = document.getElementById("spentBudget");
        const budgetDetails = document.getElementById("budgetDetails");
        
        if (totalBudget) totalBudget.value = data.totalBudget || "";
        if (spentBudget) spentBudget.value = data.spentBudget || "";
        if (budgetDetails) budgetDetails.value = data.budgetDetails || "";
        updateBudgetDisplay();

        // Timeline laden
        const timelineEvents = document.getElementById("timelineEvents");
        if (timelineEvents) timelineEvents.value = data.timelineEvents || "";

        // Risiken laden
        if (data.risks && data.risks.length > 0) {
            const riskTable = document.getElementById("riskTable");
            riskTable.innerHTML = "";
            data.risks.forEach(risk => {
                const row = document.createElement("tr");
                const bgColor = risk.level === "Hoch" ? "#dc3545" : risk.level === "Mittel" ? "#ffc107" : "#28a745";
                row.innerHTML = `
                    <td>${risk.name}</td>
                    <td><span style="padding: 4px 8px; border-radius: 4px; color: white; background: ${bgColor};">${risk.level}</span></td>
                    <td><input type="text" placeholder="MaÃŸnahmen" value="${risk.measures || ""}" onchange="saveProjectPlanning()" style="width: 100%;"></td>
                    <td><select onchange="saveProjectPlanning();"><option ${risk.status === "Offen" ? "selected" : ""}>Offen</option><option ${risk.status === "In Arbeit" ? "selected" : ""}>In Arbeit</option><option ${risk.status === "GelÃ¶st" ? "selected" : ""}>GelÃ¶st</option></select></td>
                `;
                riskTable.appendChild(row);
            });
        }

        // QualitÃ¤t laden
        const qualityMetrics = document.getElementById("qualityMetrics");
        const blockers = document.getElementById("blockers");
        if (qualityMetrics) qualityMetrics.value = data.qualityMetrics || "";
        if (blockers) blockers.value = data.blockers || "";
    } catch (e) {
        console.error("Fehler beim Laden:", e);
    }
}

/* Init */
document.addEventListener("DOMContentLoaded", () => {
    const u = localStorage.getItem("currentUser");
    if (u) {
        currentUser = u;
        loadProjectPlanning();
    }
    setActiveNav();
});

function setActiveNav() {
    document.querySelectorAll("nav a").forEach(link => {
        link.classList.remove("active");
        if (link.href.includes("projektplanung.html")) {
            link.classList.add("active");
        }
    });
}

// Auto-Save
document.addEventListener("change", saveProjectPlanning);
document.addEventListener("input", () => updateBudgetDisplay());

window.addEventListener("beforeunload", () => {
    if (currentUser) saveProjectPlanning();
});
</script>

</body>
</html>
